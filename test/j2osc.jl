# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #
#
# Description
# ==========================================================================================
#
#   Tests related to the J2 osculating orbit propagator.
#
# # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # # #

############################################################################################
#                                       Test Results
############################################################################################
#
# The following test results were obtained using a numerical propagator as shown in:
#
#   https://github.com/JuliaSpace/PropagatorTests/
#
# Initial Mean Elements (TOD)
# ==========================================================================================
#
#            Epoch :    2.45995e6 (2023-01-01T00:00:00)
#  Semi-major axis : 7190.98     km
#     Eccentricity :    0.001111
#      Inclination :   98.405    °
#             RAAN :   90.0      °
#  Arg. of Perigee :  200.0      °
#     True Anomaly :   45.0      °
#
# Numerical Propagation Results
# ==========================================================================================
#
# Gravity model         : EGM-2008 (Degree 2, Order 0)
# Integration algorithm : AutoVern7(Rodas5())
#
#  Time [s] │ Pos. X (TOD)  Pos. Y (TOD)  Pos. Z (TOD)  Vel. X (TOD)  Vel. Y (TOD)  Vel. Z (TOD)
#           │           km            km            km        km / s        km / s        km / s
# ──────────┼────────────────────────────────────────────────────────────────────────────────────
#       0.0 │     -952.620     -3037.855     -6443.618        -0.461         6.746        -3.118
#     600.0 │    -1034.200      1321.180     -6993.631         0.197         7.315         1.341
#    1200.0 │     -731.196      5189.310     -4936.498         0.780         5.164         5.294
#    1800.0 │     -156.377      7128.140     -1039.726         1.074         1.091         7.276
#    2400.0 │      476.608      6416.382      3244.734         0.968        -3.386         6.545
#    3000.0 │      932.662      3321.458      6321.676         0.503        -6.598         3.382
#    3600.0 │     1042.884     -1005.263      7048.743        -0.148        -7.361        -1.037
#    4200.0 │      765.950     -4957.911      5152.573        -0.746        -5.388        -5.082
#    4800.0 │      203.574     -7060.998      1331.479        -1.068        -1.392        -7.243
#    5400.0 │     -434.906     -6521.068     -2988.582        -0.991         3.134        -6.689
#    6000.0 │     -910.694     -3540.162     -6187.882        -0.544         6.479        -3.631
#
############################################################################################

@testset "J2 Osculating Orbit Propagator" verbose = true begin
    # Create a matrix with the results.
    results = [
           0.0  -952.620 -3037.855 -6443.618 -0.461  6.746 -3.118
         600.0 -1034.200  1321.180 -6993.631  0.197  7.315  1.341
        1200.0  -731.196  5189.310 -4936.498  0.780  5.164  5.294
        1800.0  -156.377  7128.140 -1039.726  1.074  1.091  7.276
        2400.0   476.608  6416.382  3244.734  0.968 -3.386  6.545
        3000.0   932.662  3321.458  6321.676  0.503 -6.598  3.382
        3600.0  1042.884 -1005.263  7048.743 -0.148 -7.361 -1.037
        4200.0   765.950 -4957.911  5152.573 -0.746 -5.388 -5.082
        4800.0   203.574 -7060.998  1331.479 -1.068 -1.392 -7.243
        5400.0  -434.906 -6521.068 -2988.582 -0.991  3.134 -6.689
        6000.0  -910.694 -3540.162 -6187.882 -0.544  6.479 -3.631
    ]

    # Initialize the propagator.
    jd₀ = date_to_jd(2023, 1, 1, 0, 0, 0)
    orb = KeplerianElements(
        jd₀,
        7190.982e3,
        0.001111,
        98.405 |> deg2rad,
        90     |> deg2rad,
        200    |> deg2rad,
        45     |> deg2rad
    )
    j2d = j2osc_init(orb)

    # Compare the results.
    for k in size(results, 1)
        r, v = j2osc!(j2d, results[k, 1])

        @test results[k, 2] ≈ r[1] / 1000 atol = 2e-1
        @test results[k, 3] ≈ r[2] / 1000 atol = 2e-1
        @test results[k, 4] ≈ r[3] / 1000 atol = 2e-1
        @test results[k, 5] ≈ v[1] / 1000 atol = 1e-3
        @test results[k, 6] ≈ v[2] / 1000 atol = 1e-3
        @test results[k, 7] ≈ v[3] / 1000 atol = 1e-3
    end
end
